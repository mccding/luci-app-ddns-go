# workflow 文件名: ddns-go-plugin.yml

name: Build luci-app-ddns-go Plugin

on:
  workflow_dispatch:

env:
  IMMORTALWRT_BRANCH: master
  TARGET_PROFILE: rockchip/armv8
  PLUGIN_REPO: https://github.com/sirpdboy/luci-app-ddns-go.git

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget

      - name: Clone ImmortalWrt source code
        run: git clone https://github.com/immortalwrt/immortalwrt.git -b $IMMORTALWRT_BRANCH --depth 1 openwrt

      - name: Add ddns-go plugin repository
        run: |
          cd openwrt
          git clone $PLUGIN_REPO package/luci-app-ddns-go

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure the build
        run: |
          cd openwrt
          TARGET_NAME=$(echo "${{ env.TARGET_PROFILE }}" | tr '/' '_')
          echo "CONFIG_TARGET_${TARGET_NAME}=y" > .config
          echo "CONFIG_PACKAGE_ddns-go=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-ddns-go=m" >> .config
          make defconfig

      - name: Compile the plugin
        run: |
          cd openwrt
          # 第1步：强制编译安装所有宿主机工具，确保 libdeflate-gzip 等工具就绪
          make tools/install -j1 V=s
          # 第2步：编译最终的插件包
          make package/luci-app-ddns-go/compile -j1 V=s

      - name: Organize artifacts
        id: organize
        run: |
          mkdir -p ./artifacts
          find ./openwrt/bin/packages -type f -name "*.ipk" -exec mv {} ./artifacts/ \;
          echo "path=artifacts" >> $GITHUB_OUTPUT

      - name: Upload IPK artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ddns-go-plugin-autobuild
          name: DDNS-GO Plugin (AutoBuild)
          body: "自动编译的 luci-app-ddns-go 插件 for Rockchip aarch64"
          files: ${{ steps.organize.outputs.path }}/*.ipk
          allow_updates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
